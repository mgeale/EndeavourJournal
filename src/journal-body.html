<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link href="//fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<dom-module id="journal-body">
  <template>
    <style>

    google-map {
      height: 35vh;
      width: 85%;
      margin: 20px auto;
    }

    .date {
      font-family:"CatholicGirlsW01-Regula";
      font-size: 25px;
    }

    #marker_icon {
      margin-top: 12px;
      margin-left: 4px;
    }

    .card-content {
      margin: auto;
      width: 85%;
    }

    </style>

    <iron-signals on-iron-signal-goto-index="clickGoTo"></iron-signals>

    <iron-ajax
      auto
      url="../data/endeavour-journal.json"
      handle-as="json"
      on-response="handleResponse"
      last-response="{{response}}">
    </iron-ajax>

    <google-map
      map="{{map}}"
      zoom="3"
      latitude="-29.537951"
      longitude="161.497693"
      map-type="satellite"
      disable-default-ui="true"
      api-key="AIzaSyCEowUZnnaTudIOq3XYaQLgVD0lOr-Bn1A">
      <template is="dom-repeat" items="{{entries}}" as="entry" initial-count="1">
        <google-map-marker
          id="marker_{{index}}"
          latitude="{{entry.coordinates.latitude}}"
          longitude="{{entry.coordinates.longitude}}"
          click-events="true"
          animation=""
          on-google-map-marker-click="clickMarker">
        </google-map-marker>
      </template>
    </google-map>

    <div class="card-content">
      <div style="display:flex; justify-content:space-around;">
        <paper-button on-click="clickPrev"><i class="material-icons">keyboard_arrow_left</i></paper-button>
        <div style="display:flex;"><span class="date">{{date}}</span><div title="Marker Location" on-click="currentLocation"><i id="marker_icon" class="material-icons">location_on</i></div></div>
        <paper-button on-click="clickNext"><i class="material-icons">keyboard_arrow_right</i></paper-button>
      </div>
      <div id="content">
        <div style="text-align:center;">
          <p>Click marker to show journal entry.</p>
        </div>
      </div>
    </div>

  </template>
  <script>

  Polymer({
    is: 'journal-body',

    properties: {

      index: {
        type: Number,
        value: 615
      },

      entry: {
        type: String
      },

      entries: {
        type: Object
      },

      date: {
        type: String
      }
    },

    handleResponse: function(e) {
      this.entries = e.detail.response;
    },

    clickGoTo: function(e) {
      this.index = e.detail.target.id;
      this.currentEntry(this.index);
    },

    clickNext: function() {
      if (this.index < 1049) {
        this.index++;
        this.currentEntry(this.index);
      } else {
        this.index = 0;
        this.currentEntry(this.index);
      };
    },

    clickPrev: function() {
      if ((this.index > 0) && (this.index <= 1049)) {
        this.index--;
        this.currentEntry(this.index);
      } else {
        this.index = 1049;
        this.currentEntry(this.index);
      };
    },

    clickMarker: function(e) {
      var mapClick = e.model.__data__;
      this.index = mapClick.index;
      this.currentEntry(this.index);
    },

    currentLocation: function() {
      this.currentEntry(this.index);
      console.log(this.index);
    },

    currentEntry: function(num) {
      this.loadEntry(this.entries[num]);
      var currentMarker = document.getElementById("marker_"+num);
      (function bounceMarker() {
        currentMarker.setAttribute("animation", "BOUNCE");
        setTimeout(function() {
          currentMarker.setAttribute("animation", "");
        }, 2100);
      })();
      var markerIcon = document.getElementById("marker_icon");
      if (this.entries[num].coordinates.latitude != null) {
        markerIcon.innerHTML = "location_on";
      } else if (this.entries[num].coordinates.latitude == null) {
        markerIcon.innerHTML = "location_off";
      }
    },

    loadEntry: function(obj) {
      var item = this.$$('#content');
      this.entry = obj.filename;
      this.importHref('../data/journal-pages/' + this.entry, function(e) {
        item.innerHTML = e.target.import.body.innerHTML;
      });
      var startDate = new Date(1768,07,28);
      var splitDate = obj.date.split("-");
      var entryDate = new Date(splitDate[0], splitDate[1] -1, splitDate[2]);
      this.date = this.formatDate(entryDate);
    },

    formatDate: function(date) {
      var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      var day = date.getDate();
      var monthIndex = date.getMonth();
      var year = date.getFullYear();
      return day + ' ' + monthNames[monthIndex] + ' ' + year;
    }

  });

  </script>
</dom-module>
